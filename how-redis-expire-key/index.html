<!DOCTYPE html>
<html>
  
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">

    <title>How Redis expire Key</title>

    
    
    <meta name="description" content="4 Redis commands to set expiration There are four ways to set the expiration time in Redis:

expire key TTL(seconds): Set the key to expire after n seconds;


pexpire key TTL(milliseconds): Set...">
    <link rel="canonical" href="http://coderscat.com/how-redis-expire-key/" />
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="How Redis expire Key">
    <meta property="og:description" content="4 Redis commands to set expiration There are four ways to set the expiration time in Redis:

expire key TTL(seconds): Set the key to expire after n seconds;


pexpire key TTL(milliseconds): Set...">
    <meta property="og:url" content="http://coderscat.com/how-redis-expire-key/" />
    <meta property="og:site_name" content="Coder's Cat">
    <meta property="article:publisher" content="https://www.facebook.com/coderscat">
    <meta property="article:tag" content="">
    <meta property="article:section" content="">
    <meta property="article:published_time" content="2020-04-04 23:50:00">
    <meta property="article:modified_time" content="2020-04-04 23:50:00">
    <meta property="og:updated_time" content="2020-04-04 23:50:00">
    <meta property="og:image" content="http://coderscat.com/images/logo-show.png"/>
    <meta property="og:image:secure_url" content="http://coderscat.com/images/logo-show.png"/>
    <meta property="og:image:width" content="600">
    <meta property="og:image:height" content="400">
    <meta property="og:image:alt" content="CodersCat">
    <meta property="og:image:type" content="image/jpeg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="How Redis expire Key">
    <meta name="twitter:description" content="4 Redis commands to set expiration There are four ways to set the expiration time in Redis:

expire key TTL(seconds): Set the key to expire after n seconds;


pexpire key TTL(milliseconds): Set...">
    <meta name="twitter:site" content="@coderscat">
    <meta name="twitter:creator" content="@coderscat">
    <meta name="twitter:image" content="http://coderscat.com/images/logo-show.png"/>



    <link rel="icon" type="image/png" sizes="32x32" href="/css/images/favicon-32x32.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/css/images/favicon-16x16.ico">

    <title>
        
            How Redis expire Key | Coder&#39;s Cat
        
    </title>  
    
    
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/fonts.css">

    
<link rel="stylesheet" href="/css/plugins/code.css">

    
<link rel="stylesheet" href="/css/plugins/nprogress.min.css">

    <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">


    
<script src="/js/jquery.min.js"></script>

  <script type="text/javascript" src="/js/geopattern.min.js"></script>
  <script type="text/javascript" src="/js/nprogress.min.js"></script>


  <script type="text/javascript" async src="https://platform-api.sharethis.com/js/sharethis.js#property=5fa8f493be36290012aa2a0d&product=inline-share-buttons"></script>

  <div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
      <img src="/css/images/logo.png" width='400px' height='400px'/>
  </div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-77282254-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-77282254-2');
</script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Coder's Cat" type="application/atom+xml">
</head>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Coder's Cat</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/data-structures/" class="item-link">D&S</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/algorithms/" class="item-link">Algo</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/programming-languages/" class="item-link">PL</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/system/" class="item-link">System</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tools/" class="item-link">Tools</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      <li class="list-item" style="margin: 0">
       <a class="icon-small" href="/search">
        <span class="fa-stack fa-lg">
          <i class="fa fa-search fa-stack-1x fa-inverse" style="color:pink"></i>
        </span>
       </a>
      </li>

      <li class="list-item" style="margin: 0">
        <a class="icon-small" href="/atom.xml">
         <span class="fa-stack fa-lg">
           <i class="fa fa-rss fa-inverse" style="color:orange"></i>
         </span>
        </a>
       </li>
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/data-structures/" class="menu-link">D&S</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/algorithms/" class="menu-link">Algo</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/programming-languages/" class="menu-link">PL</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/system/" class="menu-link">System</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tools/" class="menu-link">Tools</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        


        <li class="list-item" style="margin: 0">
          <a class="icon-small" href="/search">
           <span class="fa-stack">
             <i class="fa fa-search"></i>
           </span>
          </a>
         </li>

         
      <li class="list-item" style="margin: 0">
        <a class="icon-small" href="/atom.xml">
         <span class="fa-stack fa-lg">
           <i id="rss-icon" class="fa fa-rss fa-inverse"></i>
         </span>
        </a>
       </li>

      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>How Redis expire Key</h2>
  <p class="post-date">2020-04-04</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content">
      <h2 id="4-Redis-commands-to-set-expiration"><a href="#4-Redis-commands-to-set-expiration" class="headerlink" title="4 Redis commands to set expiration"></a>4 Redis commands to set expiration</h2><p> There are four ways to set the expiration time in Redis:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/commands/expire">expire</a> key TTL(seconds): Set the key to expire after n seconds;</li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/commands/pexpire">pexpire</a> key TTL(milliseconds): Set the key to expire after n milliseconds;</li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/commands/expireat">expireat</a> key timestamp: Set the key to expire after a specific timestamp (accurate to seconds);</li>
</ul>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://redis.io/commands/pexpireat">pexpireat</a> key millisecondsTimestamp: Set the key to expire after a specific timestamp (accurate to milliseconds);</p>
<p>The time complexity is all O(1), and usages of them are similar.</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;OK&quot;</span><br>redis&gt; EXPIRE mykey 10<br>(<span class="hljs-built_in">integer</span>) 1<br>redis&gt; TTL mykey<br>(<span class="hljs-built_in">integer</span>) 10<br>redis&gt; SET mykey <span class="hljs-string">&quot;Hello World&quot;</span><br><span class="hljs-string">&quot;OK&quot;</span><br>redis&gt; TTL mykey<br>(<span class="hljs-built_in">integer</span>) -1<br>redis&gt; <br></code></pre></td></tr></table></figure>

<p> The reply of a <code>expire</code> command is:</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">1 if the timeout was set.<br>0 if key does not exist.<br></code></pre></td></tr></table></figure>

<p> If you want to remove the expiration of a key, use <strong>persist key</strong>.</p>
<h2 id="2-expiration-mechanism-in-Redis"><a href="#2-expiration-mechanism-in-Redis" class="headerlink" title="2 expiration mechanism in Redis"></a>2 expiration mechanism in Redis</h2><p> How Redis implements the strategy of removing an expired key?</p>
<p> One straight solution is we create a task with timer for those keys which set with expiration time. When the key reaches the expiration time, the timed task will be triggered to delete the key immediately.</p>
<p><strong>Advantages</strong>: Friendly to memory, this deletion strategy can ensure that expired keys will be deleted as soon as possible, and release the memory used by the key.</p>
<p><strong>Disadvantages</strong>: Not friendly to CPU. The task of deleting keys will cost CPU, and this is more obvious under the condition of high load. It may affect the server’s response time and throughput.</p>
<p> Redis is a memory key-value database designed for high performance. Let’s have a look at how it handles this challenge.</p>
<p> According to the documents of Redis, there are two mechanisms implemented to recover the memory used by expired keys.</p>
<h3 id="Passive-deletion"><a href="#Passive-deletion" class="headerlink" title="Passive deletion"></a>Passive deletion</h3><p> The expired key will continue to live in memory, but Redis adds a check process for keys with expired time.</p>
<p> The key will be deleted if it expires, and it is returned as usual if the key does not expire.</p>
<p><strong>Advantages</strong>: Friendly to CPU, passive deletion make sure we only delete a key if necessary. An expired key but never queried will continue to live.</p>
<p><strong>Disadvantages</strong>: More memory will be costed. An expired key but never queried will continue to live.</p>
<h3 id="Active-deletion"><a href="#Active-deletion" class="headerlink" title="Active deletion"></a>Active deletion</h3><p> Because of the flaws of the previous solution, Redis add another active way to delete expired keys.</p>
<p>Redis periodically check a few keys with expiration. All the keys that are already expired are deleted from the keyspace.</p>
<p> Specifically, this is what Redis does 10 times per second:</p>
<p><strong>Step 1</strong>: Test 20 random keys from the set of keys with an associated expire. Delete all the keys found expired.</p>
<p><strong>Step 2</strong>: If more than 25% of keys were expired, start again from step 1.</p>
<p> This mechanism makes sure expired keys will not cost more than 25% memory.</p>
<p> Periodic deletion can be configured with the option <code>hz</code> in redis.conf, which defaults to 10 - which means 10 executions per second.</p>
<p> To limit the memory usage of Redis, we can also configue the <code>maxmemory</code> option in <a target="_blank" rel="noopener" href="http://download.redis.io/redis-stable/redis.conf">redis.conf</a>.</p>

    </section>

     <div>
          <p style="text-align:center; color: #12472d; margin-left: 2%; margin-right: 2%;"><b>Join my <a target="_blank" rel="noopener" href="http://codercat.substack.com">Email List</a> for more insights, It's Free!&#128523;	</b></p>
          <iframe src="https://codercat.substack.com/embed" width="96%" height="350" style="border:2px solid #EEE; background:rgb(248, 244, 244); margin-left: 2%; margin-right: 2%;" frameborder="1" scrolling="no"></iframe>
      </div>
    
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Misc" >
    <span class="tag-code-index">Misc</span>
  </a>


      </div>
    

    <div class="sharethis-inline-share-buttons"></div>

    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/5-best-practices-to-keep-you-from-git-leaks/">
        <span class="nav-arrow">← </span>
        
          How To Keep Safe From Git Leaks
        
      </a>
    
    
        <a class="nav-right" href="/i-use-these-awesome-tools-for-writing/">
            
                I Use These Awesome Tools for Wr...
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>


    <!-- NAV END -->

    <script src="https://utteranc.es/client.js"
            repo="nickmose8/coderscat-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>

  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
      <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title"></strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#4-Redis-commands-to-set-expiration"><span class="toc-nav-text">4 Redis commands to set expiration</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-expiration-mechanism-in-Redis"><span class="toc-nav-text">2 expiration mechanism in Redis</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Passive-deletion"><span class="toc-nav-text">Passive deletion</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Active-deletion"><span class="toc-nav-text">Active deletion</span></a></li></ol></li></ol>
    
  </div>
</aside>

  
  <!-- Catalog END -->

</main>




<script>
  (function () {
    var url = 'http://coderscat.com/how-redis-expire-key/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer" id="footer">
    <p class="copyright">
        &copy; 2022 | CodersCat
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
 var hasLine = 'false';
 async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
     $('figure pre').each(function(i, block) {
         var figure = $(this).parents('figure');
         if (hasLine === 'false') {
             figure.find('.gutter').hide();
         }
         var lang = figure.attr('class').split(' ')[1] || 'code';
         var codeHtml = $(this).html();
         var codeTag = document.createElement('code');
         codeTag.className = lang;
         codeTag.innerHTML = codeHtml;
         $(this).attr('class', '').empty().html(codeTag);
         figure.attr('data-lang', lang.toUpperCase());
     });
 })
</script>

<script src="/js/script.js"></script>


  </body>
</html>